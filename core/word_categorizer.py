"""
Word Categorizer for Parliament Context
ระบบจัดหมวดหมู่คำสำหรับบริบทรัฐสภา
"""

from collections import defaultdict, Counter
from typing import Dict, List, Tuple

class ParliamentWordCategorizer:
    """จัดหมวดหมู่คำตามบริบทของรัฐสภาไทย (ขยายคำสำคัญในแต่ละหมวด)"""

    def __init__(self):
        # กำหนดหมวดหมู่และคำสำคัญ
        self.categories = {
            'การศึกษา': [
                'การศึกษา','เรียน','นักเรียน','นักศึกษา','ครู','อาจารย์','โรงเรียน','รร.',
                'มหาวิทยาลัย','วิทยาลัย','หลักสูตร','การเรียน','การสอน','วิชา',
                'คุณภาพการศึกษา','ทุนการศึกษา','ปริญญา','การศึกษาขั้นพื้นฐาน',
                'กระทรวงศึกษาธิการ','ศธ.','สพฐ','สอศ','อาชีวศึกษา','อาชีวะ','กศน.',
                'กยศ','กรอ.เพื่อพัฒนาการศึกษา','วิชาการ','การเรียนรู้','ห้องเรียน',
                'ห้องสมุด','นวัตกรรมการเรียนรู้','เทคโนโลยีการศึกษา','สื่อการสอน',
                'ครูผู้ช่วย','ครูอัตราจ้าง','วิทยฐานะ','ทักษะอาชีพ','ทวิศึกษา',
                'ทปอ.','อุดมศึกษา','สถาบันอุดมศึกษา','กระทรวง อว.','อว.',
                'O-NET','GAT','PAT','TCAS','รับตรง','ปฐมวัย','ประถมศึกษา','มัธยมศึกษา',
                'ศูนย์เด็กเล็ก','กสศ.','ความเสมอภาคทางการศึกษา','เรียนฟรี','อาหารกลางวัน'
            ],

            'เศรษฐกิจ': [
                'เศรษฐกิจ','เงิน','งบประมาณ','การเงิน','ธนาคาร','การค้า','การลงทุน',
                'GDP','จีดีพี','เงินเฟ้อ','อัตราดอกเบี้ย','ดอกเบี้ย','หนี้','รายได้','รายจ่าย',
                'ภาษี','พาณิชย์','อุตสาหกรรม','การส่งออก','การนำเข้า','ตลาด','ราคา',
                'เงินบาท','ดอลลาร์','หุ้น','ตลาดหลักทรัพย์','SET','mai','ดัชนีตลาด',
                'ธุรกิจ','SME','SMEs','วิสาหกิจขนาดกลางและขนาดย่อม','สภาพัฒน์','สศช.',
                'กระทรวงการคลัง','กระทรวงพาณิชย์','ธปท.','EEC','บีโอไอ','BOI',
                'ดุลการค้า','ดุลบัญชีเดินสะพัด','กำลังซื้อ','การบริโภค','ดัชนีราคา',
                'ดัชนีความเชื่อมั่น','ค่าแรงขั้นต่ำ','ว่างงาน','อัตราว่างงาน',
                'พันธบัตร','ตราสารหนี้','กองทุนรวม','ภาษีมูลค่าเพิ่ม','VAT',
                'ภาษีนิติบุคคล','ภาษีบุคคลธรรมดา','FPO','สบน.','การคลังท้องถิ่น'
            ],

            'การเมือง': [
                'การเมือง','รัฐบาล','นายกรัฐมนตรี','รัฐมนตรี','สภา','รัฐสภา',
                'สมาชิกสภาผู้แทนราษฎร','ส.ส.','ส.ว.','วุฒิสภา','พรรค','พรรคการเมือง',
                'เลือกตั้ง','ประชาธิปไตย','รัฐธรรมนูญ','นโยบาย','การปกครอง',
                'ฝ่ายค้าน','ฝ่ายรัฐบาล','คณะรัฐมนตรี','ครม.','การประชุม','มติ','ญัตติ',
                'กฎหมาย','พระราชบัญญัติ','การลงมติ','อภิปราย','อภิปรายไม่ไว้วางใจ',
                'ญัตติด่วน','ระเบียบวาระ','บรรจุระเบียบวาระ','ประธานสภา',
                'วิปฝ่ายรัฐบาล','วิปฝ่ายค้าน','กรรมาธิการ','คณะกรรมาธิการ','กมธ.',
                'กกต.','ศาลรัฐธรรมนูญ','ประกาศราชกิจจานุเบกษา','ประกาศคณะรัฐมนตรี'
            ],

            'สังคม': [
                'สังคม','ประชาชน','ชุมชน','สวัสดิการ','สังคมสงเคราะห์','คุณภาพชีวิต',
                'ความเป็นอยู่','ประชากร','ครอบครัว','เด็ก','เยาวชน','ผู้สูงอายุ',
                'คนพิการ','ผู้ด้อยโอกาส','สิทธิมนุษยชน','ความเท่าเทียม','ความยุติธรรม',
                'การพัฒนาสังคม','กระทรวงการพัฒนาสังคมและความมั่นคงของมนุษย์','พม.',
                'ความมั่นคง','ความปลอดภัย','อาชญากรรม','ความเหลื่อมล้ำ',
                'บัตรสวัสดิการแห่งรัฐ','ผู้มีรายได้น้อย','ยาเสพติด','ป้องกันอาชญากรรม',
                'ความปลอดภัยทางถนน','จิตอาสา','การคุ้มครองเด็กและสตรี'
            ],

            'สาธารณสุข': [
                'สาธารณสุข','สุขภาพ','โรงพยาบาล','แพทย์','พยาบาล','การรักษา',
                'โรค','ระบาดวิทยา','วัคซีน','ยา','บริการสุขภาพ','ประกันสุขภาพ',
                'หลักประกันสุขภาพ','หลักประกันสุขภาพถ้วนหน้า','บัตรทอง','สปสช.',
                'โควิด','COVID','การแพทย์','คลินิก','สถานพยาบาล','กระทรวงสาธารณสุข',
                'สธ.','อนามัย','โภชนาการ','สุขอนามัย','การควบคุมโรค','ผู้ป่วย',
                'การดูแลสุขภาพ','สุขภาพจิต','ซึมเศร้า','อสม.','เวชภัณฑ์','ยาพื้นฐาน',
                'โรงพยาบาลชุมชน','โรงพยาบาลศูนย์','เวชศาสตร์ป้องกัน','เลิกบุหรี่',
                'สารเสพติด','ฟิตเนส','ออกกำลังกาย','BMI','โรคอ้วน','เบาหวาน',
                'ความดันโลหิต','ไขมันในเลือด','คอเลสเตอรอล','โภชนาการเด็ก'
            ],

            'เกษตรกรรม': [
                'เกษตร','เกษตรกร','เกษตรกรรม','ชาวนา','ชาวไร่','พืช','ผลผลิต',
                'ข้าว','ยางพารา','อ้อย','ปาล์มน้ำมัน','มันสำปะหลัง','ไร่นา',
                'ปศุสัตว์','ประมง','ปุ๋ย','ชลประทาน','ฤดูกาล','เพาะปลูก',
                'กระทรวงเกษตรและสหกรณ์','กรมส่งเสริมการเกษตร','ราคาพืชผล',
                'ราคารับซื้อ','การส่งเสริมการเกษตร','เกษตรอินทรีย์','น้ำชลประทาน',
                'แปลงนา','นาข้าว','สวนยางพารา','พันธุ์พืช','เมล็ดพันธุ์','ไถนา',
                'การเพาะปลูก','ผลผลิตทางการเกษตร','ผลิตผลทางการเกษตร','ฟาร์ม',
                'เลี้ยงสัตว์','ปลูกพืช','การเกษตร','ชาวสวน','สหกรณ์การเกษตร',
                'ธกส.','ภัยแล้ง','น้ำท่วม','โรคระบาดสัตว์','โคนม','ไก่เนื้อ','สุกร',
                'เกษตรแม่นยำ','โดรนเกษตร','แปรรูปสินค้าเกษตร','แปลงใหญ่','ตลาดเกษตร'
            ],

            'กฎหมาย': [
                'กฎหมาย','พระราชบัญญัติ','พ.ร.บ.','พระราชกำหนด','พ.ร.ก.','ประมวล',
                'มาตรา','ความผิด','โทษ','ศาล','ตุลาการ','คดี','การพิจารณา','การพิพากษา',
                'อัยการ','ทนายความ','สิทธิ','หน้าที่','ข้อบังคับ','ระเบียบ','คำสั่ง',
                'กฤษฎีกา','รัฐธรรมนูญ','แก้ไขเพิ่มเติม','ปรับปรุง','ยกเลิก','บังคับใช้',
                'กระทรวงยุติธรรม','ราชกิจจานุเบกษา','ประมวลกฎหมายอาญา','แพ่ง',
                'ปกครอง','ศาลฎีกา','ศาลปกครอง','ศาลอาญา','นิติกรรม','ละเมิด','ร่างกฎหมาย',
                'ตีความ','คำพิพากษาศาลฎีกา'
            ],

            'คมนาคม': [
                'คมนาคม','ขนส่ง','การคมนาคม','ถนน','ทางหลวง','มอเตอร์เวย์','ทางด่วน',
                'รถไฟ','รางคู่','รถไฟความเร็วสูง','ไฮสปีดเทรน','สนามบิน','ท่าเรือ',
                'ท่าอากาศยาน','การจราจร','รถโดยสาร','รถไฟฟ้า','BTS','MRT','สายสี',
                'โครงข่าย','โครงสร้างพื้นฐาน','การขนส่ง','ขนส่งมวลชน','ตั๋วร่วม',
                'กระทรวงคมนาคม','กรมทางหลวง','การรถไฟ','รฟท.','กรมเจ้าท่า',
                'กรมขนส่งทางบก','ใบขับขี่','ความปลอดภัยทางถนน','เมาแล้วขับ','จุดตัดรถไฟ',
                'รถประจำทาง','รถตู้','เรือโดยสาร','ตั๋วรายเดือน'
            ],

            'พลังงาน': [
                'พลังงาน','ไฟฟ้า','น้ำมัน','ก๊าซ','แหล่งพลังงาน','พลังงานทดแทน',
                'พลังงานหมุนเวียน','โซล่าเซลล์','โซลาร์รูฟท็อป','กังหันลม','ไฟฟ้าพลังน้ำ',
                'เชื้อเพลิง','ปิโตรเลียม','ถ่านหิน','นิวเคลียร์','การไฟฟ้า','กฟผ.','กฟน.',
                'กระทรวงพลังงาน','ค่าไฟ','ค่า Ft','ราคาน้ำมัน','ประหยัดพลังงาน',
                'ไบโอดีเซล','E20','E85','LNG','LPG','สำรวจและผลิตปิโตรเลียม','โรงไฟฟ้า',
                'IPP','SPP','โครงข่ายไฟฟ้าอัจฉริยะ','สมาร์ตกริด','Smart Grid','PPA',
                'Net Metering','กองทุนเพื่อส่งเสริมการอนุรักษ์พลังงาน'
            ],

            'สื่อสารและเทคโนโลยี': [
                'เทคโนโลยี','ดิจิทัล','อินเทอร์เน็ต','โทรคมนาคม','สื่อสาร','5G',
                'คอมพิวเตอร์','ซอฟต์แวร์','แอปพลิเคชัน','ข้อมูล','ฐานข้อมูล',
                'ระบบ','นวัตกรรม','วิทยาศาสตร์','วิจัย','AI','ปัญญาประดิษฐ์',
                'กระทรวงดิจิทัลเพื่อเศรษฐกิจและสังคม','ดีอีเอส','กสทช.','โทรศัพท์','มือถือ',
                'ไซเบอร์','ความมั่นคงไซเบอร์','PDPA','คุ้มครองข้อมูลส่วนบุคคล','ข้อมูลส่วนบุคคล',
                'IoT','คลาวด์','ศูนย์ข้อมูล','ดาต้าเซ็นเตอร์','บิ๊กดาต้า','บรอดแบนด์',
                'ดาวเทียม','อวกาศ','สตาร์ทอัพ','ฟินเทค','บล็อกเชน'
            ],

            'สิ่งแวดล้อม': [
                'สิ่งแวดล้อม','มลพิษ','ขยะ','น้ำเสีย','อากาศ','ป่าไม้','ทรัพยากร',
                'ธรรมชาติ','อนุรักษ์','การอนุรักษ์','ภูเขา','แม่น้ำ','ทะเล','ชายฝั่ง',
                'ภาวะโลกร้อน','ก๊าซเรือนกระจก','คาร์บอน','พื้นที่สีเขียว','ต้นไม้',
                'กระทรวงทรัพยากรธรรมชาติและสิ่งแวดล้อม','ทส.','มลภาวะ','PM2.5',
                'EIA','EHIA','การจัดการน้ำ','อุทกภัย','ภัยแล้ง','เขื่อน','อุทยานแห่งชาติ',
                'คาร์บอนเครดิต','คาร์บอนนิวทรัล','เน็ตซีโร่','Net Zero','รีไซเคิล'
            ],

            'การต่างประเทศ': [
                'ต่างประเทศ','ระหว่างประเทศ','ความสัมพันธ์','ทูต','สถานทูต',
                'สนธิสัญญา','ข้อตกลง','อาเซียน','ASEAN','สหประชาชาติ','UN',
                'กระทรวงการต่างประเทศ','กต.','ความร่วมมือ','ประชาคมโลก',
                'การทูต','ชาติ','ประเทศ','นานาชาติ','วีซ่า','กงสุล','หนังสือเดินทาง',
                'ทวิภาคี','พหุภาคี','อินโดแปซิฟิก','APEC','G20','FTA','ODA'
            ],

            'ท่องเที่ยว': [
                'ท่องเที่ยว','นักท่องเที่ยว','แหล่งท่องเที่ยว','โรงแรม','ที่พัก',
                'การท่องเที่ยว','วัฒนธรรม','ประเพณี','เทศกาล','มรดกโลก',
                'สถานที่ท่องเที่ยว','การท่องเที่ยวแห่งประเทศไทย','ททท.',
                'กระทรวงการท่องเที่ยวและกีฬา','วีซ่าท่องเที่ยว','ฟรีวีซ่า','มาตรการวีซ่า',
                'ไกด์','บริษัททัวร์','โฮมสเตย์','Airbnb','เช็คอิน','ท่องเที่ยวชุมชน',
                'มาตรฐาน SHA','กองทุนพัฒนาการท่องเที่ยว'
            ],

            'กีฬา': [
                'กีฬา','นักกีฬา','การแข่งขัน','กรีฑา','ฟุตบอล','วอลเลย์บอล',
                'แบดมินตัน','เทเบิลเทนนิส','เทนนิส','บาสเกตบอล','โอลิมปิก',
                'ซีเกมส์','กีฬาแห่งชาติ','สนาม','สนามกีฬา','การกีฬา',
                'การแข่งขันกีฬา','การกีฬาแห่งประเทศไทย','กกท.','สมาคมกีฬา','โค้ช',
                'นักกีฬาทีมชาติ','กีฬาอาชีพ','กีฬาเยาวชน','ตั๋วชมกีฬา','ถ่ายทอดสดกีฬา','VAR'
            ],

            'แรงงาน': [
                'แรงงาน','ลูกจ้าง','นายจ้าง','คนงาน','ค่าจ้าง','เงินเดือน','สวัสดิการ',
                'ประกันสังคม','กองทุนทดแทน','ค่าล่วงเวลา','ความปลอดภัย','อาชีวอนามัย',
                'การจ้างงาน','อัตราการว่างงาน','กระทรวงแรงงาน','สำนักงานแรงงาน',
                'แรงงานต่างด้าว','พนักงาน','ผู้ประกันตน','ค่าจ้างขั้นต่ำ','สหภาพแรงงาน',
                'ไตรภาคี','จ้างเหมาบริการ','แรงงานนอกระบบ','กิ๊กอีโคโนมี','Gig Economy',
                'สิทธิประโยชน์','เลิกจ้าง','ชั่วโมงการทำงาน','ลาคลอด','ลาป่วย',
                'กรมพัฒนาฝีมือแรงงาน','กพร.แรงงาน'
            ],

            'มหาดไทย': [
                'มหาดไทย','ท้องถิ่น','อบต.','เทศบาล','อบจ.','กรุงเทพมหานคร','กทม.',
                'จังหวัด','อำเภอ','ตำบล','หมู่บ้าน','ผู้ว่าราชการจังหวัด','นายอำเภอ',
                'กำนัน','ผู้ใหญ่บ้าน','ปกครองท้องถิ่น','การปกครองส่วนท้องถิ่น',
                'กระทรวงมหาดไทย','กรมการปกครอง','ทะเบียนบ้าน','บัตรประชาชน',
                'ผังเมือง','ที่ดินชุมชน','ปภ.','ป้องกันและบรรเทาสาธารณภัย','อปพร.'
            ]
        }
        
        # สร้าง reverse mapping (คำ -> หมวดหมู่)
        self.word_to_category = {}
        for category, words in self.categories.items():
            for word in words:
                if word not in self.word_to_category:
                    self.word_to_category[word] = []
                self.word_to_category[word].append(category)
    
    def categorize_words(self, word_frequency: Dict[str, int]) -> Dict[str, Dict[str, int]]:
        """
        จัดหมวดหมู่คำตามความถี่
        
        Args:
            word_frequency: Dictionary ของคำและความถี่
            
        Returns:
            Dictionary ของหมวดหมู่และคำในแต่ละหมวดหมู่พร้อมความถี่
        """
        categorized = defaultdict(lambda: defaultdict(int))
        uncategorized = {}
        
        for word, frequency in word_frequency.items():
            found = False
            best_match = None
            best_match_length = 0
            
            # 1. ตรวจสอบ Exact match ก่อน (มีความสำคัญสูงสุด)
            if word in self.word_to_category:
                for category in self.word_to_category[word]:
                    categorized[category][word] = frequency
                    found = True
            
            # 2. ถ้าไม่มี exact match ให้หาคำที่ใกล้เคียงที่สุด
            if not found:
                for category, keywords in self.categories.items():
                    for keyword in keywords:
                        # ให้คะแนนความเข้ากันของคำ
                        # - คำที่เหมือนกันทุกประการได้คะแนนสูงสุด
                        # - คำที่มีความยาวใกล้เคียงกันและมีส่วนประกอบเหมือนกันได้คะแนนสูง
                        
                        if keyword == word:
                            # Exact match (สำหรับกรณีที่ไม่อยู่ใน word_to_category)
                            best_match = category
                            best_match_length = len(keyword)
                            break
                        elif len(keyword) >= 3 and keyword in word:
                            # Substring match (คำหลักอยู่ในคำที่ตรวจสอบ)
                            # เช่น "การศึกษา" อยู่ใน "การศึกษาขั้นพื้นฐาน"
                            if len(keyword) > best_match_length:
                                best_match = category
                                best_match_length = len(keyword)
                        elif len(word) >= 3 and len(keyword) >= 3 and word in keyword:
                            # Reverse substring (คำที่ตรวจสอบอยู่ในคำหลัก)
                            # แต่ให้คะแนนต่ำกว่า
                            if len(word) > best_match_length * 0.7:
                                best_match = category
                                best_match_length = int(len(word) * 0.7)
                
                if best_match:
                    categorized[best_match][word] = frequency
                    found = True
            
            # คำที่ไม่อยู่ในหมวดหมู่ใดๆ
            if not found:
                uncategorized[word] = frequency
        
        # เพิ่มหมวดหมู่ "อื่นๆ" สำหรับคำที่ไม่จัดหมวดหมู่ได้
        if uncategorized:
            categorized['อื่นๆ'] = uncategorized
        
        return dict(categorized)
    
    def get_category_summary(self, categorized_words: Dict[str, Dict[str, int]]) -> List[Tuple[str, int, int]]:
        """
        สรุปจำนวนคำและความถี่รวมในแต่ละหมวดหมู่
        
        Args:
            categorized_words: ผลลัพธ์จาก categorize_words()
            
        Returns:
            List of (หมวดหมู่, จำนวนคำเฉพาะ, ความถี่รวม)
        """
        summary = []
        for category, words in categorized_words.items():
            unique_count = len(words)
            total_frequency = sum(words.values())
            summary.append((category, unique_count, total_frequency))
        
        # เรียงตามความถี่รวมจากมากไปน้อย
        summary.sort(key=lambda x: x[2], reverse=True)
        return summary
    
    def get_top_words_by_category(self, categorized_words: Dict[str, Dict[str, int]], 
                                   top_n: int = 5) -> Dict[str, List[Tuple[str, int]]]:
        """
        ดึงคำที่มีความถี่สูงสุดในแต่ละหมวดหมู่
        
        Args:
            categorized_words: ผลลัพธ์จาก categorize_words()
            top_n: จำนวนคำที่ต้องการดึง
            
        Returns:
            Dictionary ของหมวดหมู่และ top words
        """
        top_words = {}
        for category, words in categorized_words.items():
            sorted_words = sorted(words.items(), key=lambda x: x[1], reverse=True)
            top_words[category] = sorted_words[:top_n]
        
        return top_words
    
    def get_available_categories(self) -> List[str]:
        """ดึงรายการหมวดหมู่ทั้งหมด"""
        return list(self.categories.keys())

